磁力计
LSM303_readMag函数
使用SPI3将数据读取到buf数组当中


IMU融合的到的陀螺仪数据用于姿态内环的角速度控制,得到的角度数据用于姿态的外环控制
位置上的速度信息用来做位置的内环控制
融合补偿后的位置信息做位置外环控制
加速度和位置做卡尔曼滤波
加速度积分为速度,速度积分是位置.这是通过加速度预测的位置,然后位置传感器或者摄像头得到了另一个位置信息
相当于一直在更新一个权重,(相信实际还是相信预测多一点),不停的进行迭代
卡尔曼有几个参数,q和r,有一个参数是用来设置实际数据的误差(例如手册上写的误差为0.1,这个参数的数值就是0.1),然后另一个参数是让你更相信实际还是更相信预测



Q1:磁力计读取的数值是做什么用的?
Q2:使用遥控连接飞行的时候,是通过哪个文件去对电机进行转速输出的,√
Q3:我想找一个整体的连续的程序框架图,到底上位机中;调整的PID参数的入口在哪个文件



首先看带系统的程序,要有一个时间概念和优先级概念
1.整理时间和优先级,做完打勾,√
2.控制算法各个任务的服务关系
	IMU解算任务优先级最高,执行频率最高
	优先级为7的位置融合任务的输出给了优先级为8的位置外环
	优先级为8的位置外环的输出给了优先级为6的位置内环
	优先级为6的位置内环的输出是 目标角度 给优先级5的姿态环



Q4:主要对油门数值有影响的是那四个参数





传感器组成:
	姿态,惯性传感器:陀螺仪,加速度计,磁力计
	位置:超声波传感器,气压计,GPS定位,RTK高精度定位,射频传感器组,摄像头模组,面阵雷达,红外等感光传感器
	图像:摄像头模组,感光扫描器件
	通信交互:4/5G通信,433通信,GPRS\4G模块,语音识别模块,蜂鸣器LED等

	陀螺仪:
	校准,静止放置后,取100次数据进行平滑滤波处理作为3个轴的Offset.根据对应数据手册中的偏置\噪声\比例因子误差简历陀螺仪的简单特性模型,进行误差公式计算,采集校准数据进行校准
	加速度计
	测量运载体线加速度的仪表,准确的说,它检测的不是加速度,而是受到的惯性力
	通过获得重力加速度在其x/y轴上的分量,我们可以计算出物体相对于水平面的倾斜角度
	在三维空间中做变速运动的时候,它的输出为轴向加速度和重力加速度的分量,并不能用来计算物体的姿态和运动状态
	在姿态计算中,一般采用陀螺仪的动态数据为主体,加速度计用于做修正陀螺仪的积分误差
	Q5:东北天上的角度?为什么要做z轴方向上分类讨论?
	磁力计:
	可用于测量磁场强度和方向,定位设备的方位,与指南针原理类似,可以测量出当前设备和东南西北四个方向上的夹角

	超声波的数据滤波:
		对采样的样本进行排序
		记录每个数据的原先和排序后的序号
		对排序后的数据两两做差
		寻找出误差突变最大的两个数据的原始序号
		去突变前和突变后的需要的数据进行平均值滤波
	
	超声波定位:
		利用3面垂直的墙壁进行定位,要求墙面平整,中间不能有障碍
		在空间某些位置放置发射端,利用散射角,接收主体计算出道每个发射端的距离后,进行坐标转换.点越多越好	
	气压计:
		使用卡尔曼滤波对高度信息进行处理
	图像采集传感器:
		获取坐标信息(必须结合高度和倾角)
		物体和人脸识别
		颜色识别
		视觉里程计


	


	姿态解算:
		加速度,使用三角公式得到绝对角度(动态不稳定)
		角速度,通过角速度积分累加得到角度(动态稳定,长时间不稳定)
		磁力计,用于计算方位角(航向),(易受磁场干扰,需要倾角补偿)
		一般用法:	主用角速度和加速度,磁力计做为矫正纠正作用
	姿态融合:
		由于常用的陀螺仪和加速度计的噪声很大,会产生漂移
		所以要使用一些数据融合算法
		惯性传感器姿态融合:
		1.互补滤波;2.mahony滤波(带反馈的互补滤波);3.扩展卡尔曼滤波(复杂,计算量大)
	Q6:四元数,欧拉角?
	

四元数/欧拉角/DCM方向余弦矩阵都是姿态的三种表达方式

欧拉角最为直观
无人机控制也用的欧拉角
那么欧拉角的定义是地理坐标系和无人机载体坐标系的夹角叫做欧拉角
欧拉角四元数和DCM之间能够使用数学进行相互转换

DCM方向余弦矩阵的意思是:
	每一个矩阵元素都是欧拉角的余弦表达方式
	尤格萨隆公式,用于欧拉角和四元数之间的转换



对于一个确定的向量,用不同的坐标表示时,它们所表示的大小和方向一定是相同的,但是由于这两个坐标系的旋转矩阵存在误差
	(旋转矩阵就是DCM矩阵?)
那么当一个向量经过这么一个有误差的旋转矩阵之后,在另一个坐标系中肯定和理论值是有偏差的


一开始加速度向量定位(0,0,1),是为什么啊
估算的载体加速度向量



首先姿态表示是使用的欧拉角/四元数/DCM
最终使用了四元数
对于姿态解算算法,其本质就是不停的修整方向余弦矩阵,矩阵对了之后,从载体坐标系转化到地理坐标系的向量也是对的了
在无人机中用的载体坐标系下的数据只有角速度



在地理坐标系下,静止状态下只有一个竖直向下的重力加速度
所以001
每一次的解算,都当作一次暂停或者静止
每一次的解算,陀螺仪的角速度不停的积分,加速度不停的纠正
因为陀螺仪的积分会有累计误差,而且积分出来的数值是相对角度
但是载体静止(每一次解算都当作一种静止?)加速度就能得到准确的角度
所以把001转换到载体坐标系下(转换方法:重力转换的到加速度)得到理论加速度数据
并且和实际测量出来的加速度数据做叉积,叉积为零,没有误差
叉积不为零,有误差,把叉积的误差做一个pi控制,加到角速度数据上面去,作为一个补偿
补偿过后的角速度数据通过尤格萨隆公式转换成四元数,四元数重新放进旋转矩阵
形成新的旋转矩阵


从第一次结算说起,四元数的来源是角速度(积分转角度?这个角度就是欧拉角)和假定静止状态下的加速度(重力分解来的)转化而来的
----------------------------------------181014----------------------------------


姿态解算的最终目的是不停的修正地理坐标系和载体坐标系之间转换的那个DCM旋转矩阵


这个过程简述一下就是通过计算预测加速度和实际加速度之间的误差,做一个PI调节之后补偿到角速度的原始测量数据上去,然后输出当前的角速度数值,然后将补偿之后的角速度转换成角度后带入四元数形成一个新的DCM,用来做新一轮的坐标系转换,直到预测加速度和实际加速度之间的误差为零时


首先更应该明确的一个事情是,在地理坐标系下,无人机不论什么情况,都只受一个力,那就是重力,所以通过加速度计得到的预测加速度向量,先使用第一个四元数矩阵(第一个四元数矩阵的来源是测量出来的角速度转化得到的欧拉角)


加速度归一化(方便计算)
将加速度向量001(为什么每次结算的时候,这个加速度向量都为001,因为,每一次解算都当作一次静止状态)首先从地理坐标系使用DCM旋转矩阵将加速度向量转换到载体坐标系
	"首先回顾一个概念:DCM旋转矩阵,它表示的两个坐标系之间的欧拉角的余弦表示,这		个矩阵的作用是:将一个向量从一个坐标系转换到另一个坐标系"
这时候将预测加速度(暂时不知道)向量和实际加速度向量(加速度计测量出的受力分量转换而来的加速度量)作叉积,得到一个误差(偏差角度的余弦),然后对误差做一个PI调节,补偿叠加到原始角速度数据向量上面去
通过四元数,将补偿后的角速度转换为四元数向量在带入DCM,形成新的旋转矩阵,用于做新一轮的坐标系转换,直到误差为零,方向余弦矩阵正确,姿态数据正确

PPT记录第三章P52



21:03 2018/10/17
一共使用了两个矩阵,一个是地转载(原矩阵的转置矩阵),一个是载转地(原四元数矩阵)

加速度测量数据的原始数据是基于载体坐标系下的
所有的传感器测量出来的数据都是载体坐标系下








































































